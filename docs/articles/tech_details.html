<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical Details : identification and estimation • causalTransportR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Technical Details : identification and estimation">
<meta property="og:description" content="causalTransportR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">causalTransportR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/generalization.html">Effect Generalization</a>
    </li>
    <li>
      <a href="../articles/mlrate.html">Covariate Adjustment using ML predictions</a>
    </li>
    <li>
      <a href="../articles/omnibus.html">Omnibus Tests for Treatment Effect Heterogeneity</a>
    </li>
    <li>
      <a href="../articles/tech_details.html">Technical Details : identification and estimation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tech_details_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Technical Details : identification and estimation</h1>
                        <h4 data-toc-skip class="author">Apoorva Lal</h4>
            <address class="author_afil">
      Netflix<br><h4 data-toc-skip class="date">2022-10-18</h4>
      
      
      <div class="hidden name"><code>tech_details.Rmd</code></div>

    </address>
</div>

    
    
<!--- For HTML renders - selection from math_shortcuts.tex --->
<p><span class="math inline">\(\DeclareMathOperator*{\argmin}{argmin}\)</span> <span class="math inline">\(\newcommand{\abs}[1]{\left\vert {#1} \right\vert}\)</span> <span class="math inline">\(\newcommand{\indep}{\perp\!\!\!\perp}\)</span> <span class="math inline">\(\newcommand{\var}{\mathrm{Var}}\)</span> <span class="math inline">\(\newcommand{\ephi}{\varephilon}\)</span> <span class="math inline">\(\newcommand{\phii}{\varphi}\)</span> <span class="math inline">\(\newcommand{\tra}{^{\top}}\)</span> <span class="math inline">\(\newcommand{\sumin}{\sum_{i=1}^n}\)</span> <span class="math inline">\(\newcommand{\sumiN}{\sum_{i=1}^n}\)</span> <span class="math inline">\(\newcommand{\norm}[1]{\left\Vert{#1} \right\Vert}\)</span> <span class="math inline">\(\newcommand\Bigpar[1]{\left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Bigbr[1]{\left[ #1 \right ]}\)</span> <span class="math inline">\(\newcommand\Bigcr[1]{\left\{ #1 \right \}}\)</span> <span class="math inline">\(\newcommand\SetB[1]{\left\{ #1 \right\}}\)</span> <span class="math inline">\(\newcommand\Sett[1]{\mathcal{#1}}\)</span> <span class="math inline">\(\newcommand{\Data}{\mathcal{D}}\)</span> <span class="math inline">\(\newcommand{\Ubr}[2]{\underbrace{#1}_{\text{#2}}}\)</span> <span class="math inline">\(\newcommand{\Obr}[2]{ \overbrace{#1}^{\text{#2}}}\)</span> <span class="math inline">\(\newcommand{\sumiN}{\sum_{i=1}^N}\)</span> <span class="math inline">\(\newcommand{\dydx}[2]{\frac{\partial #1}{\partial #2}}\)</span> <span class="math inline">\(\newcommand\Indic[1]{\mathbb{1}_{#1}}\)</span> <span class="math inline">\(\newcommand{\Realm}[1]{\mathbb{R}^{#1}}\)</span> <span class="math inline">\(\newcommand{\Exp}[1]{\mathbb{E}\left[#1\right]}\)</span> <span class="math inline">\(\newcommand{\Expt}[2]{\mathbb{E}_{#1}\left[#2\right]}\)</span> <span class="math inline">\(\newcommand{\Var}[1]{\mathbb{V}\left[#1\right]}\)</span> <span class="math inline">\(\newcommand{\Covar}[1]{\text{Cov}\left[#1\right]}\)</span> <span class="math inline">\(\newcommand{\Prob}[1]{\mathbf{Pr}\left(#1\right)}\)</span> <span class="math inline">\(\newcommand{\Supp}[1]{\text{Supp}\left[#1\right]}\)</span> <span class="math inline">\(\newcommand{\doyx}{\Prob{Y \, |\,\mathsf{do} (X = x)}}\)</span> <span class="math inline">\(\newcommand{\doo}[1]{\Prob{Y |\,\mathsf{do} (#1) }}\)</span> <span class="math inline">\(\newcommand{\R}{\mathbb{R}}\)</span> <span class="math inline">\(\newcommand{\Z}{\mathbb{Z}}\)</span> <span class="math inline">\(\newcommand{\wh}[1]{\widehat{#1}}\)</span> <span class="math inline">\(\newcommand{\wt}[1]{\widetilde{#1}}\)</span> <span class="math inline">\(\newcommand{\wb}[1]{\overline{#1}}\)</span> <span class="math inline">\(\newcommand\Ol[1]{\overline{#1}}\)</span> <span class="math inline">\(\newcommand\Ul[1]{\underline{#1}}\)</span> <span class="math inline">\(\newcommand\Str[1]{#1^{*}}\)</span> <span class="math inline">\(\newcommand{\F}{\mathsf{F}}\)</span> <span class="math inline">\(\newcommand{\ff}{\mathsf{f}}\)</span> <span class="math inline">\(\newcommand{\Cdf}[1]{\mathbb{F}\left(#1\right)}\)</span> <span class="math inline">\(\newcommand{\Cdff}[2]{\mathbb{F}_{#1}\left(#2\right)}\)</span> <span class="math inline">\(\newcommand{\Pdf}[1]{\mathsf{f}\left(#1\right)}\)</span> <span class="math inline">\(\newcommand{\Pdff}[2]{\mathsf{f}_{#1}\left(#2\right)}\)</span> <span class="math inline">\(\newcommand{\dd}{\mathsf{d}}\)</span> <span class="math inline">\(\newcommand\Normal[1]{\mathcal{N} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Unif[1]{\mathsf{U} \left[ #1 \right ]}\)</span> <span class="math inline">\(\newcommand\Bern[1]{\mathsf{Bernoulli} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Binom[1]{\mathsf{Bin} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Pois[1]{\mathsf{Poi} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\BetaD[1]{\mathsf{Beta} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Diri[1]{\mathsf{Dir} \left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\Gdist[1]{\mathsf{Gamma} \left( #1 \right )}\)</span> <span class="math inline">\(\def\mbf#1{\mathbf{#1}}\)</span> <span class="math inline">\(\def\mrm#1{\mathrm{#1}}\)</span> <span class="math inline">\(\def\mbi#1{\boldsymbol{#1}}\)</span> <span class="math inline">\(\def\ve#1{\mbi{#1}}\)</span> <span class="math inline">\(\def\vee#1{\mathbf{#1}}\)</span> <span class="math inline">\(\newcommand{\Mat}[1]{\mathbf{#1}}\)</span> <span class="math inline">\(\newcommand{\eucN}[1]{\norm{#1}}\)</span> <span class="math inline">\(\newcommand{\lzero}[1]{\norm{#1}_0}\)</span> <span class="math inline">\(\newcommand{\lone}[1]{\norm{#1}_1}\)</span> <span class="math inline">\(\newcommand{\ltwo}[1]{\norm{#1}_2}\)</span> <span class="math inline">\(\newcommand{\pnorm}[1]{\norm{#1}_p}\)</span></p>
<p><code>causalTransportR</code> relies on a framework for the missing data problem in generalization and transportation that is outlined in gory detail in this document.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="section level3">
<h3 id="data-preliminaries">Data Preliminaries<a class="anchor" aria-label="anchor" href="#data-preliminaries"></a>
</h3>
<ul>
<li>
<span class="math inline">\(a \in \Sett{A} := \SetB{1, \dots, K}\)</span> treatment</li>
<li>
<span class="math inline">\(X \in \R^p\)</span> covariates</li>
<li>
<span class="math inline">\(Z \in \R^q\)</span> surrogate (short-term) outcomes</li>
<li>
<span class="math inline">\(Y \in \R\)</span> outcome</li>
<li>
<span class="math inline">\(S \in \SetB{0, 1}\)</span> selection indicator: takes on value 1 in the experimental sample, 0 otherwise.</li>
</ul>
<p>We conjecture the existence of potential outcomes <span class="math inline">\(Y^a\)</span> and <span class="math inline">\(Z^a\)</span> for each value of treatment <span class="math inline">\(a\)</span> for the long-term and surrogate outcomes respectively.</p>
<p>The selection indicator <span class="math inline">\(S\)</span> defines two subpopulations.</p>
<ul>
<li>
<span class="math inline">\(S = 1\)</span> : The trial sample. We observe <span class="math inline">\(\SetB{A_i, X_i, Y_i}_{i = 1}^n\)</span> for these observations. Call these individuals <span class="math inline">\(\Sett{S}_1\)</span>.</li>
<li>
<span class="math inline">\(S = 0\)</span> : The extrapolation sample. There are two data availability cases for this subsample:
<ul>
<li>Individual covariates <span class="math inline">\(X_i\)</span> observed for each observation in the trial sample. Call these <span class="math inline">\(\Sett{S}_0\)</span>. The treatment <span class="math inline">\(a\)</span> may or may not be observed, and the outcome <span class="math inline">\(Y\)</span> is never observed.</li>
<li>Aggregate summary statistics : <span class="math inline">\(\Ol{X}\)</span> sample averages and higher moments observed for extrapolation sample. No treatment or outcome information is available.</li>
</ul>
</li>
</ul>
<p>The union of these subpopulations is called the <em>overall</em> sample <span class="math inline">\(\Sett{S}_0 \cup \Sett{S}_1\)</span>.</p>
<p>With the above data, our estimators will rely on a handful of nuisance functions (sample analogues <span class="math inline">\(\wh{\alpha}\)</span> fit using machine learning estimators with cross-fitting)</p>
<ul>
<li>
<span class="math inline">\(\mu^a(x) = \Exp{Y | A = a , X = x}\)</span>: Outcome model. Typically only estimable in <span class="math inline">\(\Sett{S}_1\)</span>.</li>
<li>
<span class="math inline">\(\pi^a(x) = \Prob{A = a | X = x , S = 1}\)</span>: Treatment propensity model (henceforth Propensity score). Typically known in an RCT (i.e. the <span class="math inline">\(\Sett{S}_1\)</span> sample).</li>
<li>
<span class="math inline">\(\rho(x) = \Prob{S = 1 | X = x}\)</span> : Selection propensity model (henceforth Selection score). Typically unknown.</li>
<li>
<span class="math inline">\(\nu(a, z, x) = \Exp{Y | A = a , Z = z, X = x}\)</span>: Augmented outcome model which includes surrogate predictors.</li>
</ul>
</div>
<div class="section level3">
<h3 id="estimands">Estimands<a class="anchor" aria-label="anchor" href="#estimands"></a>
</h3>
<p>We may be interested in a few estimands. We write marginal means as <span class="math inline">\(\phi\)</span> and causal contrasts as <span class="math inline">\(\tau\)</span>.</p>
<div class="section level4">
<h4 id="baseline">Baseline<a class="anchor" aria-label="anchor" href="#baseline"></a>
</h4>
<p><span class="math display">\[
\phi^1_a = \Exp{Y^a | S = 1}
\]</span></p>
<p><span class="math display">\[
\tau^1(a, a') = \Exp{\tau^1_{a, a'}(X) | S = 1} = \Exp{Y^a - Y^{a'} | S = 1}
\]</span></p>
<p>This is identified under standard assumptions since the treatment is randomized in the experimental sample.</p>
</div>
<div class="section level4">
<h4 id="generalisation">Generalisation<a class="anchor" aria-label="anchor" href="#generalisation"></a>
</h4>
<p><span class="math display">\[
\phi_a = \Exp{Y^a}
\]</span></p>
<p><span class="math display">\[
\tau(a, a') = \Exp{ \tau^0_{a, a'}(X)} = \Exp{Y^a - Y^{a'} }
\]</span></p>
<p>This is the treatment effect in the overall population <span class="math inline">\(\Sett{S} := \Sett{S}_1 \cup \Sett{S}_0\)</span>, which encompasses the trial sample and the extrapolation sample.</p>
</div>
<div class="section level4">
<h4 id="transportation">Transportation<a class="anchor" aria-label="anchor" href="#transportation"></a>
</h4>
<p><span class="math display">\[
\phi^0_a = \Exp{Y^a | S = 0}
\]</span></p>
<p><span class="math display">\[
\tau^0(a, a') = \Exp{\tau^0_{a, a'}(X) | S = 0} = \Exp{Y^a - Y^{a'} | S = 0}
\]</span></p>
<p>Estimating this is challenging because we don’t observed <span class="math inline">\(Y\)</span> for anyone in the <span class="math inline">\(\Sett{S}_0\)</span> sample, so we must extrapolate our estimates of <span class="math inline">\(\tau(\cdot)\)</span> from the <span class="math inline">\(\Sett{S}_1\)</span> sample. All potential outcomes are missing.</p>
</div>
</div>
<div class="section level3">
<h3 id="identification-assumptions">Identification Assumptions<a class="anchor" aria-label="anchor" href="#identification-assumptions"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<em>Consistency / SUTVA</em> : <span class="math inline">\(Y_i = \Indic(A_i = a) Y^a_i\)</span>. This rules out interference.</li>
<li>
<em>Unconfoundedness in experiment</em>: <span class="math inline">\(Y^0, \dots, Y^a \indep A | X = x, S = 1\)</span>. This is guaranteed by randomization.</li>
<li>Overlap
<ol style="list-style-type: lower-alpha">
<li>
<em>Propensity overlap in trial</em>: <span class="math inline">\(\Prob{A = a | X = x , S = 1}\)</span>
</li>
<li>
<em>Selection overlap</em>: <span class="math inline">\(\Prob{S = 1 | X = x) &gt; 0}\)</span>
</li>
</ol>
</li>
<li>
<em>Ignorability of trial participation / Missingness at Random (MAR)</em>
<ol style="list-style-type: lower-alpha">
<li>
<span class="math inline">\(Y^0, \dots, Y^a \indep S | X = x\)</span>. This requires that trial participation is as good as random given covariates <span class="math inline">\(X\)</span>. Note that this is weaker than <em>Missingness Completely at Random (MCAR)</em>, which would require unconditional independence between potential outcomes and selection and obviate the need for any adjustment. This can be weakened to</li>
<li>
<em>Marginal model / Heterogeneous effect stability</em>: This requires ‘outcome model stability’ (<span class="math inline">\(\phi_a(X | S = 0) = \phi_a(X | S = 1)\)</span>), i.e. expected potential outcomes as a function of covariates are identical across trial and extrapolation populations. This also implies that causal contrasts are stable across trial and extrapolation populations. <span class="math inline">\(\Exp{\tau_{a, a'}(X)| S = 1} = \Exp{\tau_{a, a'}(X)| S = 0}\)</span>
</li>
<li>
<em>Mean exchangeability</em>: <span class="math inline">\(\Exp{Y^a | X = x, S = 1, A = a} = \Exp{Y^a | X = x, A = a} = \Exp{Y^a | X = x}\)</span>.</li>
</ol>
</li>
</ol>
<p>Under A1-A4, marginal means <span class="math inline">\(\phi_a, \phi^0_a\)</span>, and causal contrasts <span class="math inline">\(\tau(a, a')\)</span> and <span class="math inline">\(\tau^0(a, a')\)</span> in the overall and target sample respectively are point identified. A4 is the most demanding condition and must be evaluated with care for each use case. Under weak violations of A4, partial identification is still possible.</p>
</div>
</div>
<div class="section level2">
<h2 id="estimators">Estimators<a class="anchor" aria-label="anchor" href="#estimators"></a>
</h2>
<p>We write estimators for generic counterfactual means <span class="math inline">\(\phi\)</span>. Each estimator characterised by its <em>influence function</em> <span class="math inline">\(\psi(z)\)</span>, which solves the moment condition <span class="math inline">\(\Exp{\psi(\cdot)} = 0\)</span>, where <span class="math inline">\(\psi(z)\)</span> is typically of form <span class="math inline">\(\text{Estimator} - \tau\)</span> such that it obeys</p>
<p><span class="math display">\[
\sqrt{n} (\wh{\phi} - \phi) = \frac{1}{n} \sumin \psi(z) / \sqrt{n} + O_p(1)
\]</span></p>
<p>This makes it a Regular and Asymptotically Normal (RAL) and allows us to construct valid confidence intervals. For each influence function, we omit the <span class="math inline">\(-\tau\)</span> piece for clarity.</p>
<p>To illustrate the estimation library, we generate some synthetic experimental data and illustrate the use of the <code>ateGT</code> function for each use case.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulate RCT</span></span>
<span><span class="va">treatprob</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="co"># workhorse</span></span>
<span><span class="va">dgp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10000</span>, <span class="va">p</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">treat.prob</span> <span class="op">=</span> <span class="va">treatprob</span>,</span>
<span>                <span class="co"># bounds of X</span></span>
<span>                <span class="va">Xbounds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                <span class="co"># nonlinear heterogeneity</span></span>
<span>                <span class="va">tauF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                <span class="co"># nonlinear y0</span></span>
<span>                <span class="va">y0F</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                <span class="co"># nonlinear selection</span></span>
<span>                <span class="va">selF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span>, <span class="va">Xbounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">Xbounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span>    <span class="va">a</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">treat.prob</span><span class="op">)</span></span>
<span>    <span class="co"># generate outcomes using supplied functions</span></span>
<span>    <span class="va">TAU</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="va">tauF</span><span class="op">)</span></span>
<span>    <span class="va">Y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="va">y0F</span><span class="op">)</span></span>
<span>    <span class="va">selscore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="va">selF</span><span class="op">)</span></span>
<span>    <span class="co"># outcome</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;&lt;-</span> <span class="op">(</span><span class="va">a</span> <span class="op">*</span> <span class="va">TAU</span> <span class="op">+</span> <span class="va">Y0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># selection</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">selscore</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="co"># set outcomes for s = 0 as missing</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"True effect\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">TAU</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># this function populates the global namespace using &lt;&lt;- ; not recommended for real use</span></span>
<span><span class="fu">dgp</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## True effect</span></span>
<span><span class="co">## 1.16714</span></span></code></pre>
<p>The true generalization effect is 1.1671402. The true transportation effect is 1.585578. They are different because the selection score includes <span class="math inline">\(X_3\)</span>, which also moderates the treatment effect.</p>
<p>The naive difference in means is severely downward biased.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">a</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">a</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8135869</span></span></code></pre>
<p>Using the doubly-robust AIPW estimator does not improve things much.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aipw.html">aipw</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">a</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.3630470 0.02128147 0.3213353 0.4047587    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.1918666 0.02194327 1.1488578 1.2348754    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 0.8288196 0.02867180 0.7726228 0.8850163    0</span></span></code></pre>
<div class="section level3">
<h3 id="outcome-modelling-om">Outcome Modelling (OM)<a class="anchor" aria-label="anchor" href="#outcome-modelling-om"></a>
</h3>
<p>If high quality estimation of conditional response surfaces <span class="math inline">\(\Exp{Y | A = a, S = 1}\)</span> is feasible, and the outcome model truly is stable across treatment and selection subsamples (A4b), the counterfactual means and causal contrasts in both generalization and transportation cases are identified by simple extrapolation over the relevant samples.</p>
<div class="section level4">
<h4 id="generalisation-1">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-1"></a>
</h4>
<p><span class="math display">\[
\Exp{Y^a} = \Expt{\Sett{S}_0 \cup \Sett{S}_1}{\mu^a(X)}
\]</span></p>
<p>where the expectation is taken with respect to the overall sample (i.e. marginalizing over <span class="math inline">\(S=0\)</span> and <span class="math inline">\(S=1\)</span> subsamples). Its sample analogue is</p>
<p><span class="math display">\[
\wh{\phi}_a =
\frac{1}{\abs{\Sett{S}_0 \cup \Sett{S}_1}} \sum_{i \in \Sett{S}_0 \cup
\Sett{S}_1} \wh{\mu}^{a}(X_i)
\]</span></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"generalize"</span>, estimator <span class="op">=</span> <span class="st">"OM"</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est          se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.3156708 0.005133740 0.3056087 0.3257329    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.4340213 0.007440637 1.4194376 1.4486049    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.1183505 0.005334528 1.1078948 1.1288062    0</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="transportation-1">transportation<a class="anchor" aria-label="anchor" href="#transportation-1"></a>
</h4>
<p><span class="math display">\[
\Exp{Y^a} = \Expt{\Sett{S}_0}{\mu^a(X)}
\]</span></p>
<p>with sample analogue</p>
<p><span class="math display">\[
\wh{\phi}^0_a =
\frac{1}{\abs{\Sett{S}_0}} \sum_{i \in \Sett{S}_0} \wh{\mu}^{a}(X_i)
\]</span></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"transport"</span>, estimator <span class="op">=</span> <span class="st">"OM"</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est          se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.2600017 0.007354422 0.2455871 0.2744164    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.7208079 0.009964147 1.7012782 1.7403376    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.4608062 0.006205822 1.4486428 1.4729696    0</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="reweighting">Reweighting<a class="anchor" aria-label="anchor" href="#reweighting"></a>
</h3>
<p>Another reasonable strategy is to reweight the observations in <span class="math inline">\(\Sett{S}_1\)</span> to resemble the target sample (either the overall sample <span class="math inline">\(\Sett{S}_0 \cup \Sett{S}_1\)</span> or the extrapolation sample <span class="math inline">\(\Sett{S}_0\)</span>). Different target samples imply different weights.</p>
<p>Generic estimators for the two targets are</p>
<p><span class="math display">\[
\Exp{Y^a} = \omega_i  \frac{\Indic{A = a}}{\pi^a(X)} Y
\]</span></p>
<p><span class="math display">\[
\Exp{Y^a | S = 0} = \omega_i^0  \frac{\Indic{A = a}}{\pi^a(X)} Y
\]</span></p>
<div class="section level4">
<h4 id="inverse-selection-weights-isw">Inverse Selection Weights (ISW)<a class="anchor" aria-label="anchor" href="#inverse-selection-weights-isw"></a>
</h4>
<p>Inverse selection scores are an obvious candidate for a first set weights.</p>
<div class="section level5">
<h5 id="generalisation-2">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-2"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a} = \frac{S}{\rho(X)}  \frac{\Indic{A = a}}{\pi^a(X)} Y
\]</span></p>
<p>The inverse selection weights <span class="math inline">\(1/\rho(X)\)</span> downweight observations that are over-represented in the experimental sample relative to the overall sample, and vice versa.</p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}_a =
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\frac{S_i}{\wh{\rho}(X_i)}  \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)} Y_i
\]</span></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"generalize"</span>, estimator <span class="op">=</span> <span class="st">"ISW"</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.3253488 0.03124566 0.2641073 0.3865903    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.4652592 0.06120733 1.3452928 1.5852256    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.1399104 0.06941169 1.0038634 1.2759573    0</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="transportation-2">transportation<a class="anchor" aria-label="anchor" href="#transportation-2"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a | S = 0} = \frac{S(1 - \rho(X))}{\rho(X)}  \frac{\Indic{A = a}}{\pi^a(X)} Y
\]</span></p>
<p>The inverse selection weights <span class="math inline">\((1-\rho(X))/\rho(X)\)</span> downweight observations that are over-represented in the experimental sample relative to the extrapolation sample, and vice versa.</p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}^1_a =
\frac{1}{\abs{\Sett{S}_0}}
\sum_{i \in \Sett{S}_1}
\frac{S_i(1 - \wh{\rho}(X_i))}{\wh{\rho}(X_i)}  \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)} Y_i
\]</span></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"transport"</span>, estimator <span class="op">=</span> <span class="st">"ISW"</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.2738876 0.03650136 0.2023449 0.3454303    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.8460260 0.08032468 1.6885897 2.0034624    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.5721384 0.08849108 1.3986959 1.7455810    0</span></span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="augmented-isw-aisw">Augmented ISW (AISW)<a class="anchor" aria-label="anchor" href="#augmented-isw-aisw"></a>
</h4>
<p>We may want to combine the ISW and OM approaches into a more robust approach that works well when either <span class="math inline">\(\rho, \pi\)</span> or <span class="math inline">\(\mu\)</span> is correctly specified</p>
<div class="section level5">
<h5 id="generalisation-3">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-3"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a} = \mu(a, X)  +
      \frac{1}{\rho(X)}
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) )
\]</span></p>
<p>This estimator ‘augments’ the outcome model with an weighted average of residuals (<span class="math inline">\(Y - \mu(\cdot)\)</span>).</p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}_a =
\frac{1}{\abs{\Sett{S}_0 \cup \Sett{S}_1}}
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\mu}^{a}(X_i) +
  \frac{S_i}{\wh{\rho}(X_i)}
      \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)} (Y_i - \wh{\mu}^a(X_i) )
\]</span></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"generalize"</span>, estimator <span class="op">=</span> <span class="st">"AISW"</span>, noi <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.3026286 0.02816369 0.2474278 0.3578295    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.4963845 0.02742900 1.4426237 1.5501454    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.1937559 0.03866555 1.1179714 1.2695404    0</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="transportation-3">transportation<a class="anchor" aria-label="anchor" href="#transportation-3"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a | S = 0} = \mu(a, X)  +
      \frac{1}{\rho(X)}
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) )
\]</span></p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}^1_a =
\frac{1}{\abs{\Sett{S}_0 }}
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
  (1 - S_i)  \wh{\mu}^{a}(X_i) +
   \frac{S_i(1 - \wh{\rho}(X_i))}{\wh{\rho}(X_i)}
      \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)} (Y_i - \wh{\mu}^a(X_i) )
\]</span></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"transport"</span>, estimator <span class="op">=</span> <span class="st">"AISW"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="calibration-weighting-cw">Calibration Weighting (CW)<a class="anchor" aria-label="anchor" href="#calibration-weighting-cw"></a>
</h4>
<p>Estimating a propensity score and taking its inverse can have sub-optimal behaviour if certain observations have very small values, or if the propensity model is misspecified. Alternatively, we may seek to directly solve for balancing weights that guarantee balance</p>
<p><span class="math display">\[
\sum_{i \in \Sett{S}_0} \omega_i c_{ij}(X_ij) \approx \sum_{i \in
\Sett{S}_0 \cup \Sett{S}_1} c_{ij}(X_ij)
\]</span></p>
<p>in specified moment functions <span class="math inline">\(c_{ij}\)</span> (typically identity functions, which implies means and higher moments) between the experimental sample and target sample (either the overall or extrapolation sample). These weights are ‘automatic’ in the sense that they do not require a choice of parametric model for the outcome or propensity model, and have been shown to exhibit excellent performance in finite samples.</p>
<p>A popular calibration weight is the entropy weight, which involves solving the following (convex) program</p>
<p><span class="math display">\[\begin{align*}
  \max_{\mathbf{w}} H(w) &amp;= - \sum_{i : i \in \mathcal{S}_1 } w_i \log w_i \\
  \text{Balance constraints:} &amp; \sum_{i : i \in \mathcal{S}_1} w_i c_{ri}(\mathbf{X}_i) =
      m_r(X_j) \text{ with } r \in 1, \dots, R   \\
  \text{Proper weights:} &amp; \sum_{i : i \in \mathcal{S}_1} w_i = 1 \; \; \text{and }
  w_i \geq 0 \; \forall \; \{i: i \in \mathcal{S}_1 \}
\end{align*}\]</span></p>
<p>This convex program has <span class="math inline">\(R\)</span> balance constraints that seek to equate functions <span class="math inline">\(c_{ri}(X_i)\)</span> in a source sample <span class="math inline">\(\mathcal{S}_1\)</span> to a target value <span class="math inline">\(m_r\)</span> (which may be different for the overall or extrapolation sample). Solving the dual of the above problem is computationally very fast and scales well.</p>
<p>Entropy balancing is also double-robust: it is consistent when the outcome model is linear OR if the selection model is log-linear.</p>
<div class="section level5">
<h5 id="generalisation-4">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-4"></a>
</h5>
<p>Set <span class="math inline">\(m_r(X_j)\)</span> to be the average covariate values in the overall sample. Solve the ebal program and obtain weights <span class="math inline">\(\wh{\omega}_i\)</span></p>
<p><span class="math display">\[
\wh{\phi}_a =
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\omega}_i
\frac{\Indic{A = a}}{\wh{\pi}^a(X)} Y
\]</span></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"generalize"</span>, estimator <span class="op">=</span> <span class="st">"CW"</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.4742417 0.03478469 0.4060638 0.5424197    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.8476831 0.05210291 1.7455614 1.9498048    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.3734414 0.06517506 1.2456983 1.5011845    0</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="transportation-4">transportation<a class="anchor" aria-label="anchor" href="#transportation-4"></a>
</h5>
<p>Set <span class="math inline">\(m_r(X_j)\)</span> to be the average covariate values in the extrapolation sample. Solve the ebal program and obtain weights <span class="math inline">\(\wh{\omega}_i^1\)</span></p>
<p><span class="math display">\[
\wh{\phi}_a =
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\omega}_i^1
\frac{\Indic{A = a}}{\wh{\pi}^a(X)} Y
\]</span></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"transport"</span>, estimator <span class="op">=</span> <span class="st">"CW"</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.4629304 0.04965513 0.3656064 0.5602545    0</span></span>
<span><span class="co">## 2      E{Y(1)} 2.3293385 0.09136245 2.1502681 2.5084089    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.8664081 0.10587890 1.6588854 2.0739307    0</span></span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="augmented-calibration-weighting-acw">Augmented Calibration weighting (ACW)<a class="anchor" aria-label="anchor" href="#augmented-calibration-weighting-acw"></a>
</h4>
<p>As with AISW, we may want to combine the ICW and OM approaches into a more robust approach that works well when either weights or <span class="math inline">\(\mu\)</span> is correctly specified</p>
<div class="section level5">
<h5 id="generalisation-5">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-5"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a} = \mu(a, X)  +
      \omega
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) )
\]</span></p>
<p>This estimator ‘augments’ the outcome model with an weighted average of residuals (<span class="math inline">\(Y - \mu(\cdot)\)</span>).</p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}_a =
\frac{1}{\abs{\Sett{S}_0 \cup \Sett{S}_1}}
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\mu}^{a}(X_i) +
\wh{\omega}_i
\frac{\Indic{A = a}}{\wh{\pi}^a(X)} (Y - \wh{\mu}^a(X) )
\]</span></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"generalize"</span>, estimator <span class="op">=</span> <span class="st">"ACW"</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter      est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.312567 0.01732877 0.2786026 0.3465314    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.442708 0.01776030 1.4078982 1.4775186    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.130141 0.02374645 1.0835983 1.1766844    0</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="transportation-5">transportation<a class="anchor" aria-label="anchor" href="#transportation-5"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a | S = 0} = \mu(a, X)  +
      \omega^1
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) )
\]</span></p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}^1_a =
\frac{1}{\abs{\Sett{S}_0 }} \sum_{i \in \Sett{S}_0}
\wh{\mu}^{a}(X_i) +
\wh{\omega}_i^1
\frac{\Indic{A = a}}{\wh{\pi}^a(X)} (Y - \wh{\mu}^a(X) )
\]</span></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateGT.html">ateGT</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span>, <span class="va">X</span>, <span class="va">s</span>, target <span class="op">=</span> <span class="st">"transport"</span>, estimator <span class="op">=</span> <span class="st">"ACW"</span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 0.2318273 0.03578722 0.1616844 0.3019703    0</span></span>
<span><span class="co">## 2      E{Y(1)} 1.8084866 0.03650755 1.7369318 1.8800414    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 1.5766593 0.05009439 1.4784743 1.6748443    0</span></span></code></pre>
</div>
</div>
</div>
<div class="section level3">
<h3 id="surrogate-models">Surrogate Models<a class="anchor" aria-label="anchor" href="#surrogate-models"></a>
</h3>
<p>When surrogate outcomes (outcomes that are measured between baseline randomisation and endline), they may be incorporated into the analysis and produce precision gains (since outcomes tend to be correlated over time).</p>
<p>The additional assumption required for consistency here is</p>
<ul>
<li>Cohort <span class="math inline">\(S\)</span> is <em>Missing at Random (MAR)</em>: <span class="math inline">\(S \indep Y^a | (X , A = a, Z^a)\)</span>
</li>
</ul>
<div class="section level4">
<h4 id="augmented-inverse-selection-weighting-with-surrogates-aisws">Augmented Inverse Selection Weighting with Surrogates (AISWS)<a class="anchor" aria-label="anchor" href="#augmented-inverse-selection-weighting-with-surrogates-aisws"></a>
</h4>
<p>Surrogates can be incorporated into the AISW estimator with an additional debiasing piece</p>
<div class="section level5">
<h5 id="generalisation-6">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-6"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a} = \mu(a, X)  +
      \frac{1}{\rho(X)}
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) ) +
      \frac{\Indic{A = a}}{\pi^a(X)} (\nu^a(Z, X) - \mu^a(X))
\]</span></p>
<p>This estimator ‘augments’ the outcome model with two weighted averages of residuals <span class="math inline">\(Y - \mu(\cdot)\)</span> and <span class="math inline">\(\nu(\cdot) - \mu(\cdot)\)</span>.</p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}_a =
\frac{1}{\abs{\Sett{S}_0 \cup \Sett{S}_1}}
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\mu}^{a}(X_i) +
  \frac{S_i}{\wh{\rho}(X_i)}
      \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)}
    (Y_i - \wh{\mu}^a(X_i) ) +
  \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)}
  (\wh{\nu}^a(X_i, Z_i) - \wh{\mu}^a(X_i))
\]</span></p>
</div>
<div class="section level5">
<h5 id="transportation-6">transportation<a class="anchor" aria-label="anchor" href="#transportation-6"></a>
</h5>
<p><span class="math display">\[
\Exp{Y^a} = \mu(a, X)  +
      \frac{1 - \rho(X)}{\rho(X)}
      \frac{\Indic{A = a}}{\pi^a(X)} (Y - \mu^a(X) ) +
      \frac{\Indic{A = a}}{\pi^a(X)} (\nu^a(Z, X) - \mu^a(X))
\]</span></p>
<p>Sample analogue:</p>
<p><span class="math display">\[
\wh{\phi}_a =
\frac{1}{\abs{\Sett{S}_0 \cup \Sett{S}_1}}
\sum_{i \in \Sett{S}_0 \cup \Sett{S}_1}
\wh{\mu}^{a}(X_i) +
  \frac{S_i(1- \wh{\rho}(X_i))}{\wh{\rho}(X_i)}
      \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)}
    (Y_i - \wh{\mu}^a(X_i) ) +
  \frac{\Indic{A = a}}{\wh{\pi}^a(X_i)}
  (\wh{\nu}^a(X_i, Z_i) - \wh{\mu}^a(X_i))
\]</span></p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="estimation-function-for-aggregate-data-for-target-atecal">Estimation Function for aggregate data for target: <code>ateCAL</code><a class="anchor" aria-label="anchor" href="#estimation-function-for-aggregate-data-for-target-atecal"></a>
</h2>
<p>We simulate some data and withold individual level data from the generalization / target sample.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate RCT with 10k obs</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">treat.prob</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># random assignment</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">treat.prob</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">TAU</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">X</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># step fn in outcome model</span></span>
<span><span class="va">y0</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">7</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">*</span> <span class="va">TAU</span> <span class="op">+</span> <span class="va">y0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">a</span><span class="op">)</span> <span class="op">*</span> <span class="va">y0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">*</span> <span class="va">y1</span></span>
<span><span class="co"># selection model misspecified</span></span>
<span><span class="va">selscore</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">selscore</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># now, don't feed the algorithm a, s, X for the s = 0 group</span></span></code></pre></div>
<p>Calibration and Augmented calibration estimators can be used for generalization and transportation by setting the target moments to the appropriate sample.</p>
<div class="section level3">
<h3 id="generalisation-7">generalisation<a class="anchor" aria-label="anchor" href="#generalisation-7"></a>
</h3>
<p>Truth: 0.4998786</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_moments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowMeans2.html" class="external-link">colMeans2</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ateCAL.html">ateCAL</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">a</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    treatProb <span class="op">=</span> <span class="va">treat.prob</span>,</span>
<span>    targetMoments <span class="op">=</span> <span class="va">target_moments</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"ACW"</span>, noi <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 3.0407581 0.04451131 2.9535160 3.1280003    0</span></span>
<span><span class="co">## 2      E{Y(1)} 3.4773413 0.05296667 3.3735267 3.5811560    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 0.4365832 0.03225989 0.3733538 0.4998126    0</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateCAL.html">ateCAL</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">a</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    treatProb <span class="op">=</span> <span class="va">treat.prob</span>,</span>
<span>    targetMoments <span class="op">=</span> <span class="va">target_moments</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"CW"</span>, noi <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est        se    ci.ll     ci.ul  pval</span></span>
<span><span class="co">## 1      E{Y(0)} 3.8525818 0.1011644 3.654300 4.0508640 0.000</span></span>
<span><span class="co">## 2      E{Y(1)} 4.2450770 0.1072732 4.034821 4.4553325 0.000</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 0.3924952 0.1650848 0.068929 0.7160614 0.017</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="transportation-7">transportation<a class="anchor" aria-label="anchor" href="#transportation-7"></a>
</h3>
<p>Truth: 0.5918173</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_moments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowMeans2.html" class="external-link">colMeans2</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ateCAL.html">ateCAL</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">a</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    treatProb <span class="op">=</span> <span class="va">treat.prob</span>,</span>
<span>    targetMoments <span class="op">=</span> <span class="va">target_moments</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"ACW"</span>, noi <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est         se     ci.ll     ci.ul pval</span></span>
<span><span class="co">## 1      E{Y(0)} 3.0407845 0.04625990 2.9501151 3.1314539    0</span></span>
<span><span class="co">## 2      E{Y(1)} 3.4697880 0.06309539 3.3461210 3.5934550    0</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 0.4290035 0.04857097 0.3338044 0.5242026    0</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ateCAL.html">ateCAL</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">a</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    treatProb <span class="op">=</span> <span class="va">treat.prob</span>,</span>
<span>    targetMoments <span class="op">=</span> <span class="va">target_moments</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"CW"</span>, noi <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##      parameter       est        se     ci.ll     ci.ul  pval</span></span>
<span><span class="co">## 1      E{Y(0)} 3.2393090 0.1395562 2.9657789 3.5128392 0.000</span></span>
<span><span class="co">## 2      E{Y(1)} 3.7852859 0.1481834 3.4948464 4.0757255 0.000</span></span>
<span><span class="co">## 3 E{Y(1)-Y(0)} 0.5459769 0.2134626 0.1275903 0.9643635 0.011</span></span></code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Apoorva Lal.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
